<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor GPS - Vista Simplificada</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .json-container {
            max-height: 200px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            border: 1px solid #dee2e6;
        }

        .table thead th {
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 10;
        }

        .table-container {
            max-height: 80vh;
            overflow-y: auto;
        }

        .badge-status {
            min-width: 80px;
        }
    </style>
</head>

<body>
    <div class="container-fluid py-3">
        <h1 class="h4 mb-3">Monitor GPS - Vista Simplificada</h1>

        <div class="card mb-3">
            <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <button id="refreshBtn" class="btn btn-sm btn-primary">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                    </div>
                    <div class="text-end">
                        <small class="text-muted" id="lastUpdate"></small>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table class="table table-sm table-hover">
                <thead>
                    <tr>
                        <th width="15%">Patente</th>
                        <th width="42%">Preview JSON (TrackerMasGPS)</th>
                        <th width="43%">Respuesta Wisetrack</th>
                    </tr>
                </thead>
                <tbody id="dataTable">
                    <tr>
                        <td colspan="3" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p>Cargando datos...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal para JSON completo -->
    <div class="modal fade" id="jsonModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Detalles JSON</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <pre id="modalJsonContent" class="p-3 bg-light rounded"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="copyJsonBtn">
                        <i class="fas fa-copy"></i> Copiar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script>
        // Función para formatear y acortar JSON
        function formatJsonPreview(json, maxLength = 150) {
            if (!json) return 'No hay datos';

            const str = typeof json === 'string' ? json : JSON.stringify(json, null, 2);
            if (str.length <= maxLength) return str;

            return str.substring(0, maxLength) + '...';
        }

        // Función para mostrar JSON completo en modal
        function showFullJson(content) {
            const modalContent = document.getElementById('modalJsonContent');
            const modal = new bootstrap.Modal(document.getElementById('jsonModal'));

            try {
                // Intentar formatear si es JSON válido
                const jsonObj = typeof content === 'string' ? JSON.parse(content) : content;
                modalContent.textContent = JSON.stringify(jsonObj, null, 2);
            } catch {
                // Si no es JSON válido, mostrar como texto plano
                modalContent.textContent = content;
            }

            modal.show();
        }

        // Función para cargar los datos
        async function loadData() {
            try {
                const response = await fetch('data.php');
                if (!response.ok) throw new Error('Error al cargar datos');

                const data = await response.json();
                displayData(data);

                // Actualizar hora de última actualización
                document.getElementById('lastUpdate').textContent =
                    `Última actualización: ${new Date().toLocaleTimeString('es-ES')}`;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('dataTable').innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-danger py-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error al cargar los datos: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Función para mostrar los datos en la tabla
        function displayData(vehicles) {
            const tbody = document.getElementById('dataTable');

            if (!vehicles || vehicles.length === 0) {
                tbody.innerHTML = `
            <tr>
                <td colspan="3" class="text-center text-muted py-3">
                    No se encontraron vehículos
                </td>
            </tr>
        `;
                return;
            }

            tbody.innerHTML = '';

            vehicles.forEach(vehicle => {
                const previewJson = formatJsonPreview(vehicle.json_enviado);
                const previewResponse = formatJsonPreview(vehicle.respuesta_soap);

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>
                <strong>${vehicle.patente || 'N/A'}</strong><br>
                <small class="text-muted">${vehicle.json_enviado?.imei || ''}</small>
            </td>
            <td>
                <div class="json-container" title="Click para ver completo">
                    ${previewJson}
                </div>
                <small class="text-muted d-block mt-1">
                    <span class="badge badge-status ${vehicle.json_enviado?.connection_status === 'online' ? 'bg-success' : 'bg-secondary'}">
                        ${vehicle.json_enviado?.connection_status || 'unknown'}
                    </span>
                    <span class="ms-2">${vehicle.json_enviado?.['ultima-conexion'] || ''}</span>
                </small>
            </td>
            <td>
                <div class="json-container" title="Click para ver completo">
                    ${previewResponse}
                </div>
            </td>
        `;

                // Mostrar JSON completo en modal al hacer click
                const [jsonContainer, responseContainer] = row.querySelectorAll('.json-container');

                jsonContainer.style.cursor = 'pointer';
                jsonContainer.addEventListener('click', () => showFullJson(vehicle.json_enviado));

                responseContainer.style.cursor = 'pointer';
                responseContainer.addEventListener('click', () => showFullJson(vehicle.respuesta_soap));

                tbody.appendChild(row);
            });
        }


        // Event listeners
        document.getElementById('refreshBtn').addEventListener('click', loadData);

        // Botón para copiar JSON en el modal
        document.getElementById('copyJsonBtn').addEventListener('click', () => {
            const content = document.getElementById('modalJsonContent').textContent;
            navigator.clipboard.writeText(content).then(() => {
                const btn = document.getElementById('copyJsonBtn');
                btn.innerHTML = '<i class="fas fa-check"></i> Copiado!';
                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-copy"></i> Copiar';
                }, 2000);
            });
        });

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>

</html>