<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor GPS - Vista Simplificada</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
        }
        
        body {
            background-color: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: none;
            transition: transform 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .json-container {
            max-height: 200px;
            overflow-y: auto;
            background-color: var(--light-bg);
            border-radius: 8px;
            padding: 12px;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            border: 1px solid #dee2e6;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .json-container:hover {
            background-color: #e9ecef;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
        }
        
        .table thead th {
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 10;
            font-weight: 600;
            color: var(--secondary-color);
            border-bottom: 2px solid var(--primary-color);
        }
        
        .table-container {
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .badge-status {
            min-width: 80px;
            font-weight: 500;
            letter-spacing: 0.5px;
            padding: 5px 10px;
            border-radius: 20px;
        }
        
        .badge-online {
            background-color: var(--success-color);
        }
        
        .badge-offline {
            background-color: var(--danger-color);
        }
        
        .badge-unknown {
            background-color: var(--warning-color);
        }
        
        .search-container {
            position: relative;
            max-width: 300px;
        }
        
        .search-container i {
            position: absolute;
            left: 12px;
            top: 10px;
            color: #6c757d;
        }
        
        .search-input {
            padding-left: 40px;
            border-radius: 20px;
            border: 1px solid #ced4da;
        }
        
        .header-title {
            color: var(--secondary-color);
            font-weight: 600;
            border-left: 4px solid var(--primary-color);
            padding-left: 10px;
        }
        
        .last-update {
            font-size: 0.85rem;
            color: #6c757d;
            background-color: rgba(108, 117, 125, 0.1);
            padding: 5px 10px;
            border-radius: 20px;
        }
        
        .refresh-btn {
            border-radius: 20px;
            padding: 5px 15px;
            font-weight: 500;
        }
        
        .modal-json {
            font-family: 'Consolas', monospace;
            white-space: pre-wrap;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .patente-cell {
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        .imei-text {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        
        .online {
            background-color: var(--success-color);
        }
        
        .offline {
            background-color: var(--danger-color);
        }
        
        .unknown {
            background-color: var(--warning-color);
        }
        
        .empty-state {
            padding: 40px 0;
            text-align: center;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 3rem;
            color: #dee2e6;
            margin-bottom: 15px;
        }
    </style>
</head>

<body>
    <div class="container-fluid py-3">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h4 header-title">Monitor GPS - Vista Simplificada</h1>
            <div class="last-update" id="lastUpdate">
                <i class="fas fa-clock me-1"></i> Última actualización: --
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" class="form-control form-control-sm search-input" placeholder="Buscar por patente...">
                    </div>
                    <div>
                        <button id="refreshBtn" class="btn btn-sm btn-primary refresh-btn">
                            <i class="fas fa-sync-alt me-1"></i> Actualizar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body p-0">
                <div class="table-container">
                    <table class="table table-sm table-hover mb-0">
                        <thead>
                            <tr>
                                <th width="15%">Patente</th>
                                <th width="42%">Preview JSON (TrackerMasGPS)</th>
                                <th width="43%">Respuesta Wisetrack</th>
                            </tr>
                        </thead>
                        <tbody id="dataTable">
                            <tr>
                                <td colspan="3" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <p class="mt-2">Cargando datos...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para JSON completo -->
    <div class="modal fade" id="jsonModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Detalles JSON</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <pre id="modalJsonContent" class="modal-json m-0 p-3"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="copyJsonBtn">
                        <i class="fas fa-copy me-1"></i> Copiar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script>
        // Variables globales
        let allVehiclesData = [];
        
        // Función para formatear y acortar JSON
        function formatJsonPreview(json, maxLength = 150) {
            if (!json) return 'No hay datos';

            const str = typeof json === 'string' ? json : JSON.stringify(json, null, 2);
            if (str.length <= maxLength) return str;

            return str.substring(0, maxLength) + '...';
        }

        // Función para mostrar JSON completo en modal
        function showFullJson(content, title = 'Detalles JSON') {
            const modalContent = document.getElementById('modalJsonContent');
            const modalTitle = document.getElementById('modalTitle');
            const modal = new bootstrap.Modal(document.getElementById('jsonModal'));

            modalTitle.textContent = title;

            try {
                // Intentar formatear si es JSON válido
                const jsonObj = typeof content === 'string' ? JSON.parse(content) : content;
                modalContent.textContent = JSON.stringify(jsonObj, null, 2);
            } catch {
                // Si no es JSON válido, mostrar como texto plano
                modalContent.textContent = content;
            }

            modal.show();
        }

        // Función para cargar los datos
        async function loadData() {
            try {
                document.getElementById('dataTable').innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2">Cargando datos...</p>
                        </td>
                    </tr>
                `;

                const response = await fetch('data.php');
                if (!response.ok) throw new Error('Error al cargar datos');

                const data = await response.json();
                allVehiclesData = data;
                displayData(data);

                // Actualizar hora de última actualización
                const now = new Date();
                document.getElementById('lastUpdate').innerHTML = `
                    <i class="fas fa-clock me-1"></i> Última actualización: ${now.toLocaleTimeString('es-ES')}
                `;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('dataTable').innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error al cargar los datos: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Función para filtrar datos por patente
        function filterData(searchTerm) {
            if (!searchTerm) {
                displayData(allVehiclesData);
                return;
            }

            const filteredData = allVehiclesData.filter(vehicle => {
                const patente = vehicle.patente || '';
                const imei = vehicle.json_enviado?.imei || '';
                
                return patente.toLowerCase().includes(searchTerm.toLowerCase()) || 
                       imei.toLowerCase().includes(searchTerm.toLowerCase());
            });

            displayData(filteredData);
        }

        // Función para mostrar los datos en la tabla
        function displayData(vehicles) {
            const tbody = document.getElementById('dataTable');

            if (!vehicles || vehicles.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" class="empty-state">
                            <i class="fas fa-car-alt"></i>
                            <p class="mt-2 mb-0">No se encontraron vehículos</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = '';

            vehicles.forEach(vehicle => {
                const previewJson = formatJsonPreview(vehicle.json_enviado);
                const previewResponse = formatJsonPreview(vehicle.respuesta_soap);
                
                // Determinar clase de estado
                let statusClass = 'unknown';
                if (vehicle.json_enviado?.connection_status === 'online') {
                    statusClass = 'online';
                } else if (vehicle.json_enviado?.connection_status === 'offline') {
                    statusClass = 'offline';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="patente-cell">${vehicle.patente || 'N/A'}</div>
                        <div class="imei-text">${vehicle.json_enviado?.imei || ''}</div>
                    </td>
                    <td>
                        <div class="json-container" title="Click para ver completo">
                            ${previewJson}
                        </div>
                        <small class="text-muted d-block mt-2">
                            <span class="status-indicator ${statusClass}"></span>
                            <span class="badge badge-status ${statusClass === 'online' ? 'bg-success' : statusClass === 'offline' ? 'bg-danger' : 'bg-warning'}">
                                ${vehicle.json_enviado?.connection_status || 'unknown'}
                            </span>
                            <span class="ms-2">${vehicle.json_enviado?.['ultima-conexion'] || ''}</span>
                        </small>
                    </td>
                    <td>
                        <div class="json-container" title="Click para ver completo">
                            ${previewResponse}
                        </div>
                    </td>
                `;

                // Mostrar JSON completo en modal al hacer click
                const [jsonContainer, responseContainer] = row.querySelectorAll('.json-container');

                jsonContainer.addEventListener('click', () => 
                    showFullJson(vehicle.json_enviado, `JSON enviado - ${vehicle.patente || 'N/A'}`));

                responseContainer.addEventListener('click', () => 
                    showFullJson(vehicle.respuesta_soap, `Respuesta Wisetrack - ${vehicle.patente || 'N/A'}`));

                tbody.appendChild(row);
            });
        }

        // Event listeners
        document.getElementById('refreshBtn').addEventListener('click', loadData);
        
        // Buscador
        document.getElementById('searchInput').addEventListener('input', (e) => {
            filterData(e.target.value);
        });

        // Botón para copiar JSON en el modal
        document.getElementById('copyJsonBtn').addEventListener('click', () => {
            const content = document.getElementById('modalJsonContent').textContent;
            navigator.clipboard.writeText(content).then(() => {
                const btn = document.getElementById('copyJsonBtn');
                btn.innerHTML = '<i class="fas fa-check me-1"></i> Copiado!';
                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-copy me-1"></i> Copiar';
                }, 2000);
            });
        });

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', loadData);
        
    </script>
</body>

</html>